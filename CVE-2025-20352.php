<?php
// snmp_workaround_generator_fixed.php
// Paste Cisco SNMP config -> output mitigation commands (views + v2c community bindings).
// IMPORTANT: We DO NOT modify or re-emit SNMPv3 group lines (to avoid privilege changes).

function parse_config($text) {
    $lines = preg_split('/\r?\n/', $text);
    $groups = []; // groupName => ['read_view'=>string]
    $communities = []; // community => ['mode'=>'RO'|'RW','acl'=>null|'aclname','view'=>null]

    foreach ($lines as $raw) {
        $line = trim($raw);
        if ($line === '' || strpos($line, '!') === 0) continue;

        // snmp-server group <name> v3 ... read <view> [write <view>] [notify <view>]
        if (preg_match('/^snmp-server\s+group\s+(\S+)\s+v3\s+[^\n]*$/i', $line, $m)) {
            $groupName = $m[1];
            $readView = null;
            if (preg_match('/\bread\s+(\S+)/i', $line, $r)) $readView = $r[1];
            if (!$readView) $readView = $groupName;
            $groups[$groupName] = ['read_view' => $readView];
            continue;
        }

        // snmp-server community mycomm view NO_BAD_SNMP RO [ACL]
        if (preg_match('/^snmp-server\s+community\s+(\S+)\s+view\s+(\S+)\s+(RO|RW)(?:\s+(\S+))?/i', $line, $m)) {
            $comm = $m[1];
            $view = $m[2];
            $mode = strtoupper($m[3]);
            $acl  = isset($m[4]) ? $m[4] : null;
            $communities[$comm] = ['mode'=>$mode, 'acl'=>$acl, 'view'=>$view, 'raw'=>$line];
            continue;
        }

        // snmp-server community ipamsnmp RO [ACL]
        if (preg_match('/^snmp-server\s+community\s+(\S+)\s+(RO|RW)(?:\s+(\S+))?/i', $line, $m)) {
            $comm = $m[1];
            $mode = strtoupper($m[2]);
            $acl  = isset($m[3]) ? $m[3] : null;
            $communities[$comm] = ['mode'=>$mode, 'acl'=>$acl, 'view'=>null, 'raw'=>$line];
            continue;
        }
    }

    return ['groups'=>$groups, 'communities'=>$communities];
}

function generate_workaround($parsed) {
    $out = [];

    $excludes = [
        'snmpUsmMIB',
        'snmpVacmMIB',
        'snmpCommunityMIB',
        'cafSessionMethodsInfoEntry.2.1.111',
    ];

    $views = [];

    foreach ($parsed['groups'] as $gname => $gdata) {
        if (!empty($gdata['read_view'])) $views[$gdata['read_view']] = true;
    }

    $needsNoBad = false;
    foreach ($parsed['communities'] as $info) {
        if (empty($info['view'])) $needsNoBad = true; else $views[$info['view']] = true;
    }
    if ($needsNoBad) $views['NO_BAD_SNMP'] = true;

    foreach (array_keys($views) as $view) {
        $out[] = "! View adjustments for: $view";
        $out[] = "snmp-server view $view iso included";
        foreach ($excludes as $ex) {
            $out[] = "snmp-server view $view $ex excluded";
        }
        $out[] = "";
    }

    foreach ($parsed['communities'] as $comm => $info) {
        $view = $info['view'] ?: 'NO_BAD_SNMP';
        $line = "snmp-server community $comm view $view {$info['mode']}";
        if (!empty($info['acl'])) $line .= " {$info['acl']}";
        $out[] = $line;
    }

    $out[] = "! Note: SNMPv3 groups are intentionally NOT changed.";
    $out[] = "! Mitigation may affect discovery/inventory. Validate on lab first.";

    return implode("\n", $out);
}

$input = isset($_POST['config']) ? $_POST['config'] : '';
$generated = '';
$parsed = null;
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $parsed = parse_config($input);
    $generated = generate_workaround($parsed);
}
?>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SNMP Workaround Generator</title>
<style>
body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:20px;background:#f7f7f8}
textarea{width:100%;height:240px;font-family:monospace;padding:8px}
.container{max-width:900px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
button{padding:10px 14px;font-size:16px;border-radius:6px;cursor:pointer}
.output{white-space:pre;font-family:monospace;background:#111;color:#e6ffed;padding:12px;border-radius:6px}
.note{font-size:0.9em;color:#555;margin-top:8px}
.warn{background:#331;padding:6px;border-radius:6px;margin-top:12px}
.bad{color:#fff;background:#c00;padding:2px 4px;border-radius:3px}
.medium{color:#000;background:orange;padding:2px 4px;border-radius:3px}
.copy-btn{margin-top:8px;}
</style>
</head>
<body>
<div class="container">
  <h2>SNMP Workaround Generator (CVE-2025-20352 / CSCwq31287)</h2>
  <p>This tool generates the necessary <code>snmp-server view</code> blocks and adjusts SNMPv2c communities.</p>
  <form method="post">
    <label for="config">Configuration (paste):</label>
    <textarea id="config" name="config" placeholder="snmp-server group ..."><?php echo htmlspecialchars($input); ?></textarea>
    <p><button type="submit">Generate Workaround</button></p>
  </form>

  <?php if ($parsed): ?>
    <h3>Detected SNMPv1/v2c Communities</h3>
    <div class="warn">
      <?php foreach ($parsed['communities'] as $comm => $info): ?>
        <?php if ($info['view'] === null): ?>
          <?php if ($info['acl']): ?>
            <div><span class="medium"><?php echo htmlspecialchars($info['raw']); ?></span> (has ACL)</div>
          <?php else: ?>
            <div><span class="bad"><?php echo htmlspecialchars($info['raw']); ?></span> (no ACL!)</div>
          <?php endif; ?>
        <?php endif; ?>
      <?php endforeach; ?>
    </div>
  <?php endif; ?>

  <?php if ($generated): ?>
    <h3>Generated Workaround</h3>
    <div class="output" id="output"><?php echo htmlspecialchars($generated); ?></div>
    <button class="copy-btn" onclick="copyOutput()">Copy to Clipboard</button>
    <p class="note">Note: Not all platforms support every OID exclusion (e.g. <code>cafSessionMethodsInfoEntry.2.1.111</code>). Test first. Patching is the real fix.</p>
  <?php endif; ?>

  <a href="https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-snmp-x4LPhte#wa">Cisco Advisory CSCwq31287</a>
  <br><br><br>
  <a href="index.php">Back to Index</a><br>
</div>
<script>
function copyOutput(){
  var text=document.getElementById('output').innerText;
  navigator.clipboard.writeText(text).then(()=>{
    alert('Copied to clipboard');
  });
}
</script>
</body>
</html>
