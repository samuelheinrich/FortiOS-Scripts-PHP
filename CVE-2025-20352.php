<?php
// snmp_workaround_generator_fixed.php
// Paste Cisco SNMP config -> output mitigation commands (views + v2c community bindings).
// IMPORTANT: We DO NOT modify or re-emit SNMPv3 group lines (to avoid privilege changes).

function parse_config($text) {
    $lines = preg_split('/\r?\n/', $text);
    $groups = []; // groupName => ['read_view'=>string]
    $communities = []; // community => ['mode'=>'RO'|'RW','acl'=>null|'aclname','view'=>null]

    foreach ($lines as $raw) {
        $line = trim($raw);
        if ($line === '' || strpos($line, '!') === 0) continue;

        // snmp-server group <name> v3 ... read <view> [write <view>] [notify <view>]
        if (preg_match('/^snmp-server\s+group\s+(\S+)\s+v3\s+[^\n]*$/i', $line, $m)) {
            $groupName = $m[1];
            $readView = null;
            if (preg_match('/\bread\s+(\S+)/i', $line, $r)) $readView = $r[1];
            // fallback pattern: many deployments name the view equal to the group name
            if (!$readView) $readView = $groupName;
            $groups[$groupName] = ['read_view' => $readView];
            continue;
        }

        // note existing views (optional; not strictly needed for emission)
        if (preg_match('/^snmp-server\s+view\s+(\S+)\s+(\S+)\s+(included|excluded)/i', $line, $m)) {
            // no-op; we emit (or re-emit) complete view blocks anyway
            continue;
        }

        // snmp-server community mycomm view NO_BAD_SNMP RO [ACL]
        if (preg_match('/^snmp-server\s+community\s+(\S+)\s+view\s+(\S+)\s+(RO|RW)(?:\s+(\S+))?/i', $line, $m)) {
            $comm = $m[1];
            $view = $m[2];
            $mode = strtoupper($m[3]);
            $acl  = isset($m[4]) ? $m[4] : null;
            $communities[$comm] = ['mode'=>$mode, 'acl'=>$acl, 'view'=>$view];
            continue;
        }

        // snmp-server community ipamsnmp RO IPAM_SNMPv2  (no view yet)
        if (preg_match('/^snmp-server\s+community\s+(\S+)\s+(RO|RW)(?:\s+(\S+))?/i', $line, $m)) {
            $comm = $m[1];
            $mode = strtoupper($m[2]);
            $acl  = isset($m[3]) ? $m[3] : null;
            $communities[$comm] = ['mode'=>$mode, 'acl'=>$acl, 'view'=>null];
            continue;
        }
    }

    return ['groups'=>$groups, 'communities'=>$communities];
}

function generate_workaround($parsed) {
    $out = [];

    // Cisco advisory: standard exclusions + advisory-specific mapping
    $excludes = [
        'snmpUsmMIB',
        'snmpVacmMIB',
        'snmpCommunityMIB',
        'cafSessionMethodsInfoEntry.2.1.111', // CISCO-AUTH-FRAMEWORK-MIB mapping (may not exist on all images)
    ];

    // Collect views to emit
    $views = [];

    // Include read-views referenced by v3 groups (we do NOT touch group definitions)
    foreach ($parsed['groups'] as $gname => $gdata) {
        if (!empty($gdata['read_view'])) $views[$gdata['read_view']] = true;
    }

    // If any v2c community lacks a view, we will bind it to NO_BAD_SNMP -> ensure we emit that view
    $needsNoBad = false;
    foreach ($parsed['communities'] as $info) {
        if (empty($info['view'])) $needsNoBad = true; else $views[$info['view']] = true;
    }
    if ($needsNoBad) $views['NO_BAD_SNMP'] = true;

    // Emit view blocks first
    foreach (array_keys($views) as $view) {
        $out[] = "! View adjustments for: $view";
        $out[] = "snmp-server view $view iso included";
        foreach ($excludes as $ex) {
            $out[] = "snmp-server view $view $ex excluded";
        }
        $out[] = "";
    }

    // Then emit community bindings (keep RO/RW + ACL as-is; attach NO_BAD_SNMP if none was set)
    foreach ($parsed['communities'] as $comm => $info) {
        $view = $info['view'] ?: 'NO_BAD_SNMP';
        $line = "snmp-server community $comm view $view {$info['mode']}";
        if (!empty($info['acl'])) $line .= " {$info['acl']}";
        $out[] = $line;
    }

    $out[] = "! Note: SNMPv3 groups are intentionally NOT changed.";
    $out[] = "! Mitigation may affect discovery/inventory. Validate on lab first.";

    return implode("\n", $out);
}

$input = isset($_POST['config']) ? $_POST['config'] : '';
$generated = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $parsed = parse_config($input);
    $generated = generate_workaround($parsed);
}
?>

<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SNMP Workaround Generator (fixed)</title>
<style>
body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:20px;background:#f7f7f8}
textarea{width:100%;height:240px;font-family:monospace;padding:8px}
.container{max-width:900px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
button{padding:10px 14px;font-size:16px;border-radius:6px}
.output{white-space:pre;font-family:monospace;background:#111;color:#e6ffed;padding:12px;border-radius:6px}
.note{font-size:0.9em;color:#555;margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <h2>SNMP Workaround Generator (CVE-2025-20352 / CSCwq31287)</h2>
  <p>Dieses Tool erzeugt nur die nötigen <code>snmp-server view</code>-Blöcke und passt SNMPv2c Communities an</p>
  <form method="post">
    <label for="config">Konfig (Paste):</label>
    <textarea id="config" name="config" placeholder="snmp-server group ..."><?php echo htmlspecialchars($input); ?></textarea>
    <p><button type="submit">Generate Workaround</button></p>
  </form>

  <?php if ($generated): ?>
    <h3>Ergebnis (Workaround)</h3>
    <div class="output"><?php echo htmlspecialchars($generated); ?></div>
    <p class="note">Hinweis: Nicht alle Plattformen unterstützen jede OID-Exclusion (z. B. <code>cafSessionMethodsInfoEntry.2.1.111</code>). Prüfen und ggf. anpassen. Patchen bleibt der eigentliche Fix.</p>
  <?php endif; ?>
  <a href="https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-snmp-x4LPhte#wa">
CSCwq31287</a>


        <br><br><br>
        <a href="index.php">back to Index</a><br>
</div>
</body>
</html>
